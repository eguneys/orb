import { objForeach } from './util2';

export default function Disciples() {

  this.width = 64;
  this.height = 64;

  let maps = [
    Map.main
  ];

  let tiles;
  let nbW,
      nbH;

  this.init = (data) => {
    let map = data.map;
    tiles = readMap(maps[map]);
  };

  const readMap = source => {
    let res = {};
    let lines = source.trim().split('\n');
    for (let i = 0; i < lines.length; i++) {
      let line = lines[i];
      for (let j = 0; j < line.length; j++) {
        let chr = line[j];
        res[pos2key([j, i])] = makeRole(chr);
      }
    }
    return res;
  };


  this.each = fn => {
    objForeach(tiles, (key, tile) => {
      fn(key2pos(key), tile);
    });
  };
  
  this.getPos = pos => tiles[pos2key(pos)];

}

export const pos2key = pos => pos[0] + ';' + pos[1];
export const key2pos = key => key.split(';').map(_ => parseInt(_));

const Role = {
  GROUND: {
  },
  WATER: {
  }
};

const RoleCode = {
  '.': 'GROUND',
  '~': 'WATER'
};

function roleMaker() {
  let id = 0;

  return function(roleCode) {
    id++;
    const result = {key: id};

    const role = RoleCode[roleCode];
    const obj = Role[role] || {};

    obj.role = role;

    Object.keys(obj).map((key) => {
      result[key] = obj[key];
    });

    return result;
  };
}

const makeRole = roleMaker();

const Map = {
  'main': `
...................~~~~.........................................
....................~~~.........................................
....................~~~.........................................
....................~~..........................................
...................~~...........................................
..................~~............................................
...................~~...........................................
...................~~...........................................
...................~~...........................................
..................~~............................................
..................~~............................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................

`
};
